<html lang="en" class="h-100  w-100">
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Team #5 - Let's Do Something Stupid">
    <title>Giant Siege</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
            integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"
            integrity="sha384-6khuMg9gaYr5AxOqhkVIODVIvm9ynTT5J4V1cfthmT+emCG6yVmEZsRHdxlotUnm"
            crossorigin="anonymous"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css"
          integrity="sha256-BJ/G+e+y7bQdrYkS2RBTyNfBHpA9IuGaPmf9htub5MQ=" crossorigin="anonymous"/>
    <style>
        body {
            background-color: #eeeeee;
        }

        .game-rows {
            height: 15% !important;
            background-color: #FFFFFF;
        }

        .game-rows:last-of-type {
            background-color: #eeeeee;
        }

        .progress {
            background-color: #FFFFFF;
            height: 2rem;
        }

        .button-height {
            height: 90%;
        }

        .row {
            margin-right: 0;
            margin-left: 0;
        }
</style>
</head>

<body class="h-100 w-100">
<nav class="navbar navbar-dark bg-dark">
    <a class="navbar-brand" href="#">Giant Siege</a>
</nav>
<div class="h-100">
    <div class="game-row text-center bg-white" >
        Stop the Giant from destroying the town! You have
        <strong><span id="timer"></span></strong> seconds to help the villagers save their homes!
    </div>
    <div class="row game-rows px-4 py-2">
        <button class="btn btn-danger btn-lg btn-block m-2 button-height"
                onclick="sendSelectedBuffType('IncreaseDamage')">
            <span class="oi oi-warning"></span>
            Increase damage
            <span class="badge badge-light" id="OpponentAdvantage_IncreaseDamage-vote-count">0</span>
        </button>
    </div>

    <div class="row game-rows px-4 py-2">
        <button class="btn btn-warning btn-lg btn-block m-2 button-height"
                onclick="sendSelectedBuffType('PoisonousKnights')">
            <svg version="1.1" id="IconsRepoEditor" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="20px" height="20px" viewBox="0 0 31.936 31.936" style="enable-background:new 0 0 31.936 31.936;" xml:space="preserve" fill="#000000" stroke="#000000" stroke-width="0"><g id="IconsRepo_bgCarrier"></g> <path d="M8.32,6.471c-1.565,0-2.833,1.268-2.833,2.833v19.797c0,1.564,1.268,2.834,2.833,2.834h15.294 c1.564,0,2.834-1.27,2.834-2.834V9.304c0-1.565-1.268-2.833-2.834-2.833H8.32z M23.214,25.928c0,0.908-0.738,1.646-1.646,1.646 H10.368c-0.909,0-1.645-0.737-1.645-1.646V12.62c0-0.91,0.736-1.646,1.645-1.646h11.198c0.909,0,1.646,0.737,1.646,1.646v13.308 H23.214z"></path> <path d="M12.298,21.823l0.644-1.234v2.853c0,0.348,0.217,0.666,0.526,0.82c0.554,0.271,1.554,0.635,2.912,0.635 c1.218,0,2.116-0.293,2.673-0.551c0.393-0.181,0.643-0.572,0.643-1v-2.757l0.035,0.063l0.611,1.141 c1.02-0.92,1.646-2.186,1.646-3.584c0-2.808-2.542-5.086-5.677-5.086c-3.137,0-5.688,2.278-5.688,5.086 C10.626,19.623,11.259,20.902,12.298,21.823z M17.022,18.827c0-0.175,0.154-0.257,0.33-0.257h2.027 c0.176,0,0.315,0.082,0.315,0.257v0.001c0,0.878-0.604,1.594-1.339,1.594C17.624,20.422,17.022,19.705,17.022,18.827 L17.022,18.827z M16.315,20.301c0.098,0,0.191,0.041,0.257,0.114l0.797,0.897l-0.387,0.342L16.54,21.43 c-0.138-0.072-0.301-0.07-0.438,0.002l-0.421,0.221l-0.391-0.338l0.771-0.896C16.126,20.344,16.217,20.301,16.315,20.301z M13.085,18.827c0-0.175,0.116-0.257,0.291-0.257h2.029c0.176,0,0.351,0.082,0.351,0.258l0,0c0,0.878-0.602,1.594-1.337,1.594 C13.686,20.422,13.084,19.705,13.085,18.827L13.085,18.827L13.085,18.827z"></path> <path d="M20.964,1.646c0-0.91-0.738-1.646-1.646-1.646h-6.698c-0.909,0-1.645,0.737-1.645,1.646v3.841h9.99V1.646L20.964,1.646z"></path> </svg>
            Poisonous Knights
            <span class="badge badge-light" id="OpponentAdvantage_PoisonousKnights-vote-count">0</span>
        </button>
    </div>

    <div class="row game-rows px-4 py-2">
        <button class="btn btn-info btn-lg btn-block m-2 button-height"
                onclick="sendSelectedBuffType('BlurredVision', 'MonsterDisadvantage')">
            <span class="oi oi-eye"></span>
            Blurred Vision
            <span class="badge badge-light" id="MonsterDisadvantage_BlurredVision-vote-count">0</span>
        </button>
    </div>

    <div class="row game-rows px-4 py-2">
        <button class="btn btn-success btn-lg btn-block m-2 button-height"
                onclick="sendSelectedBuffType('IncreaseReinforcements')">
            <span class="oi oi-people"></span>
            Increase Reinforcements
            <span class="badge badge-light" id="OpponentAdvantage_IncreaseReinforcements-vote-count">0</span>
        </button>
    </div>

    <div class="row game-rows p-4 border-top">
        <h3>Giant's energy level</h3>
        <div class="progress w-100 border">
            <div class="progress-bar bg-danger" id="energy-level" role="progressbar" style="width: 100%"
                 aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"><strong>100%</strong></div>
        </div>
    </div>
</div>

<script defer>
  let output;
  let socket;

  function init() {
    output = document.getElementById('output');

    createSocket()
  }

  function sendSelectedBuffType(subType, type = 'OpponentAdvantage') {
    socket.send(JSON.stringify([{
      clientType: 'Client',
      type: type,
      subType: subType,
      value: true,
    }]));
  }

  function createSocket() {
    const uri = window.location.href.replace(/^http(s)?:/, 'ws$1:').replace(/\/$/, '');
    socket = new WebSocket(uri);

    socket.onopen = (e) => {
      console.log('open', e);

      socket.send(JSON.stringify([{
        clientType: 'Client',
        type: 'Identify',
        value: true,
      }]))
    };

    socket.onmessage = (e) => {
      const events = JSON.parse(e.data);
      for (const event of events) {
        const name = `${event.type}_${event.subType || ''}`.replace(/_$/, '');
        switch (name) {
          case 'DecisionTimeTick':
            updateDecisionTime(event.value);
            break;
          case 'DecisionTimeReset':
            resetDecisionTime(event.value);
            break;
          case 'MonsterEnergyChange':
            updateGiantsEnergy(event.value);
            break;
          case 'VoteCount':
            updateVoteCounts(event.value);
            break
        }
      }
    };

    function updateDecisionTime(time) {
      document.getElementById('timer').innerText = time;
    }

    function resetDecisionTime(time) {
      document.getElementById('timer').innerText = time;

      const voteIds = [
        'OpponentAdvantage_IncreaseDamage-vote-count',
        'OpponentAdvantage_PoisonousKnights-vote-count',
        'MonsterDisadvantage_BlurredVision-vote-count',
        'OpponentAdvantage_IncreaseReinforcements-vote-count',
      ];

      for (const id of voteIds) {
        document.getElementById(id).innerText = '0';
      }
    }

    function updateVoteCounts(votes)
    {
      for (const [name, count] of Object.entries(votes)) {
        document.getElementById(`${name}-vote-count`).innerText = count;
      }
    }

    function updateGiantsEnergy(energyLevel) {
      energyLevel = Math.round(energyLevel);
      document.getElementById('energy-level').setAttribute('style', `width: ${energyLevel}%`);
      document.getElementById('energy-level').lastChild.innerHTML = `${energyLevel}%`;
    }

    socket.onerror = (e) => {
      console.log('error', e)
    }
  }

  window.addEventListener('load', init, false);
</script>
</body>


